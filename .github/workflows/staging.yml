name: 'Deploy to staging'

on:
  push:
    branches:
      - develop
  pull_request:

env:
  FIREBASE_APP_ID: '1:459872309701:web:976518a789250ece383bac'
  FIREBASE_AUTH_DOMAIN: 'headwood-1cdfb.firebaseapp.com'
  FIREBASE_MEASUREMENT_ID: 'G-ZPFSNFQVFV'
  FIREBASE_MESSAGING_SENDER_ID: '459872309701'
  FIREBASE_PROJECT_ID: 'headwood-1cdfb'
  FIREBASE_STORAGE_BUCKET: 'headwood-1cdfb.firebasestorage.app'

jobs:
  check:
    name: Staging check
    uses: ./.github/workflows/check.yml
  build:
    name: Staging build
    uses: ./.github/workflows/build.yml
    with:
      firebase_app_id: ${{ env.FIREBASE_APP_ID }}
      firebase_auth_domain: ${{ env.FIREBASE_AUTH_DOMAIN }}
      firebase_measurement_id: ${{ env.FIREBASE_MEASUREMENT_ID }}
      firebase_messaging_sender_id: ${{ env.FIREBASE_MESSAGING_SENDER_ID }}
      firebase_project_id: ${{ env.FIREBASE_PROJECT_ID }}
      firebase_storage_bucket: ${{ env.FIREBASE_STORAGE_BUCKET }}
    secrets:
      firebase_api_key: ${{ secrets.STAGING_FIREBASE_API_KEY }}
#      firebase_service_account: '${{ secrets.STAGING_FIREBASE_SERVICE_ACCOUNT }}'
#      firebase_project_id: $STAGING_FIREBASE_PROJECT_ID
      firebase_service_account_client_email: ${{ secrets.STAGING_FIREBASE_SERVICE_ACCOUNT_CLIENT_EMAIL }}
      firebase_service_account_private_key: ${{ secrets.STAGING_FIREBASE_SERVICE_ACCOUNT_PRIVATE_KEY }}
  test-e2e:
    name: Staging e2e tests
    needs:
      - build
    uses: ./.github/workflows/test-e2e.yml
    with:
      firebase_env: staging
  test-unit:
    name: Staging unit tests
    uses: ./.github/workflows/test-unit.yml
  deploy:
    name: Staging deploy
    needs:
      - check
      - build
      - test-unit
      - test-e2e
    uses: ./.github/workflows/deploy.yml
    with:
      firebase_env: staging
    secrets:
      firebase_service_account: '${{ secrets.STAGING_FIREBASE_SERVICE_ACCOUNT }}'
